<% const _chapters = Array.isArray(manga.chapters) ? manga.chapters : []; %>
<% const _idx = _chapters.findIndex(ch => ch.slug === chapter.slug); %>
<% const prevChapter = _idx > 0 ? _chapters[_idx - 1] : null; %>
<% const nextChapter = _idx >= 0 && _idx < _chapters.length - 1 ? _chapters[_idx + 1] : null; %>

<nav class="sticky top-0 z-30 bg-surface/95 backdrop-blur border-b border-white/5" data-hide-when-drawer>
  <div class="max-w-4xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2 justify-center">
    <div>
      <% if (prevChapter) { %>
        <a href="/manga/<%= manga.slug %>/<%= prevChapter.slug %>" class="px-3 py-2 rounded bg-surface2 hover:bg-surface">Prev</a>
      <% } else { %>
        <button class="px-3 py-2 rounded bg-surface2 opacity-50" disabled>Prev</button>
      <% } %>
    </div>
    <div>
        <select class="chapter-select bg-surface2 rounded px-2 py-2">
          <% _chapters.forEach(ch => { %>
            <option value="/manga/<%= manga.slug %>/<%= ch.slug %>" <%= ch.slug === chapter.slug ? 'selected' : '' %>><%= ch.title %></option>
          <% }); %>
        </select>
    </div>
    <div>
        <select class="page-select bg-surface2 rounded px-2 py-2">
          <% pages.forEach((page, index) => { %>
            <option value="#page-<%= index + 1 %>">Page <%= index + 1 %></option>
          <% }); %>
        </select>
    </div>
    <div class="flex items-center gap-2">
      <button class="px-3 py-2 rounded bg-surface2 hover:bg-surface" id="mode-long">Long</button>
      <button class="px-3 py-2 rounded bg-surface2 hover:bg-surface" id="mode-single">Single</button>
    </div>
    <div>
      <% if (nextChapter) { %>
        <a href="/manga/<%= manga.slug %>/<%= nextChapter.slug %>" class="px-3 py-2 rounded bg-surface2 hover:bg-surface">Next</a>
      <% } else { %>
        <button class="px-3 py-2 rounded bg-surface2 opacity-50" disabled>Next</button>
      <% } %>
    </div>
  </div>
</nav>

<div class="max-w-4xl mx-auto px-4 py-4 text-center">
  <h1 class="text-lg font-semibold"><a href="/manga/<%= manga.slug %>" class="hover:text-brand"><%= manga.title %></a> - <%= chapter.title %></h1>
  </div>

<div class="max-w-4xl mx-auto px-2 page-container">
  <% pages.forEach((page, index) => { %>
    <div class="text-center">
        <img class="w-full h-auto disable-save" src="<%= page %>" alt="Page <%= index + 1 %>" id="page-<%= index + 1 %>" loading="lazy" decoding="async" draggable="false" oncontextmenu="return false;">
    </div>
  <% }); %>
</div>

<!-- Bottom Prev/Next navigation -->
<div class="max-w-4xl mx-auto px-4 mt-6 mb-4">
  <div class="flex items-center justify-between bg-surface rounded p-3">
    <div>
      <% if (prevChapter) { %>
        <a href="/manga/<%= manga.slug %>/<%= prevChapter.slug %>" class="px-3 py-2 rounded bg-surface2 hover:bg-surface">Prev</a>
      <% } else { %>
        <button class="px-3 py-2 rounded bg-surface2 opacity-50" disabled>Prev</button>
      <% } %>
    </div>
    <div class="text-sm text-gray-300 truncate max-w-[60%] text-center">
      <%= manga.title %> â€” <%= chapter.title %>
    </div>
    <div>
      <% if (nextChapter) { %>
        <a href="/manga/<%= manga.slug %>/<%= nextChapter.slug %>" class="px-3 py-2 rounded bg-surface2 hover:bg-surface">Next</a>
      <% } else { %>
        <button class="px-3 py-2 rounded bg-surface2 opacity-50" disabled>Next</button>
      <% } %>
    </div>
  </div>
</div>

<!-- Reactions + Comments -->
<div class="max-w-4xl mx-auto px-2 mt-8 space-y-4">
  <div class="bg-surface rounded p-4 mt-4">
    <h3 class="font-semibold mb-3 text-white">What do you think?</h3>
    <div class="flex flex-wrap gap-2 items-center">
      <% const emojis = ['up','funny','love','surprised','angry','sad']; %>
      <% const labels = { up:'Upvote', funny:'Funny', love:'Love', surprised:'Surprised', angry:'Angry', sad:'Sad' }; %>
      <% emojis.forEach(e => { %>
        <form action="/manga/<%= manga.slug %>/<%= chapter.slug %>/react" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="emoji" value="<%= e %>">
          <button class="px-3 py-1.5 rounded bg-surface2 hover:bg-surface text-sm">
            <span class="font-semibold"><%= (reactions && reactions[e]) || 0 %></span> <%= labels[e] %>
          </button>
        </form>
      <% }) %>
    </div>
  </div>

  <div class="bg-surface rounded p-4" id="comments">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-semibold text-white">Comments</h3>
      <div class="text-sm space-x-2">
        <a class="px-2 py-1 rounded bg-surface2 <%= (sortMode==='best') ? 'ring-1 ring-brand' : '' %>" href="?sort=best">Best</a>
        <a class="px-2 py-1 rounded bg-surface2 <%= (sortMode==='new' || sortMode==='newest') ? 'ring-1 ring-brand' : '' %>" href="?sort=new">Newest</a>
        <a class="px-2 py-1 rounded bg-surface2 <%= (sortMode==='old' || sortMode==='oldest') ? 'ring-1 ring-brand' : '' %>" href="?sort=old">Oldest</a>
      </div>
    </div>
    <% if (user) { %>
      <form action="/manga/<%= manga.slug %>/<%= chapter.slug %>/comment" method="POST" class="mb-4">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <textarea name="body" rows="3" class="w-full bg-surface2 rounded px-3 py-2" placeholder="Join the discussion..."></textarea>
        <div class="mt-2">
          <% if (turnstileEnabled && turnstileSiteKey) { %>
          <div class="cf-turnstile mb-2" data-sitekey="<%= turnstileSiteKey %>" data-theme="auto"></div>
          <% } %>
          <button class="px-4 py-2 rounded bg-brand hover:bg-indigo-500 text-white">Post</button>
        </div>
      </form>
    <% } else { %>
      <p class="text-sm text-gray-300 mb-3">Log in to join the conversation.</p>
    <% } %>
    <div class="space-y-4">
      <% (comments || []).forEach(c => { %>
        <div class="flex items-start gap-3">
          <img src="<%= c.avatar || '/avatars/default.svg' %>" alt="avatar" width="40" height="40" class="w-10 h-10 rounded-full object-cover bg-surface2">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold"><%= c.nickname || c.username %> <span class="text-xs text-gray-400"><%= c.created_at %></span></p>
            <p class="text-gray-200 break-words"><%= c.body %></p>
            <div class="mt-2 flex items-center gap-2 text-xs text-gray-300">
              <form action="/comment/<%= c.id %>/react" method="POST">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="emoji" value="up">
                <input type="hidden" name="returnTo" value="/manga/<%= manga.slug %>/<%= chapter.slug %>#comments">
                <button class="px-2 py-1 rounded bg-surface2">Like (<%= c.upvotes || 0 %>)</button>
              </form>
              <form action="/comment/<%= c.id %>/react" method="POST">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="emoji" value="down">
                <input type="hidden" name="returnTo" value="/manga/<%= manga.slug %>/<%= chapter.slug %>#comments">
                <button class="px-2 py-1 rounded bg-surface2">Dislike (<%= c.downvotes || 0 %>)</button>
              </form>
              <% if (user) { %>
              <details>
                <summary class="cursor-pointer select-none px-2 py-1 rounded bg-surface2">Reply</summary>
                <form action="/manga/<%= manga.slug %>/<%= chapter.slug %>/comment" method="POST" class="mt-2">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input type="hidden" name="parent_id" value="<%= c.id %>">
                  <input type="hidden" name="redirectHash" value="#comments">
                  <textarea name="body" rows="2" class="w-full bg-surface2 rounded px-3 py-2" placeholder="Write a reply..."></textarea>
                  <div class="mt-2">
                    <% if (turnstileEnabled && turnstileSiteKey) { %>
                    <div class="cf-turnstile mb-2" data-sitekey="<%= turnstileSiteKey %>" data-theme="auto"></div>
                    <% } %>
                    <button class="px-3 py-1.5 rounded bg-brand text-white">Post Reply</button>
                  </div>
                </form>
              </details>
              <% } %>
            </div>
            <% if (c.replies && c.replies.length) { %>
              <div class="mt-3 space-y-3 pl-6 border-l border-white/5">
                <% const extra = c.replies.slice(3); const first = c.replies.slice(0,3); %>
                <% first.forEach(r => { %>
                  <div class="flex items-start gap-3">
                    <img src="<%= r.avatar || '/avatars/default.svg' %>" alt="avatar" width="32" height="32" class="w-8 h-8 rounded-full object-cover bg-surface2">
                    <div class="flex-1 min-w-0">
                      <p class="text-sm font-semibold"><%= r.nickname || r.username %> <span class="text-xs text-gray-400"><%= r.created_at %></span></p>
                      <p class="text-gray-200 break-words"><%= r.body %></p>
                    </div>
                  </div>
                <% }) %>
                <% if (extra.length) { %>
                  <div data-more-replies class="hidden">
                  <% extra.forEach(r => { %>
                    <div class="flex items-start gap-3 mt-3">
                      <img src="<%= r.avatar || '/avatars/default.svg' %>" alt="avatar" width="32" height="32" class="w-8 h-8 rounded-full object-cover bg-surface2">
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold"><%= r.nickname || r.username %> <span class="text-xs text-gray-400"><%= r.created_at %></span></p>
                        <p class="text-gray-200 break-words"><%= r.body %></p>
                      </div>
                    </div>
                  <% }) %>
                  </div>
                  <button type="button" class="mt-2 text-xs px-2 py-1 rounded bg-surface2 hover:bg-surface" data-toggle-replies>Show more replies (<%= extra.length %>)</button>
                <% } %>
              </div>
            <% } %>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-toggle-replies]').forEach(btn => {
        btn.addEventListener('click', () => {
          const more = btn.previousElementSibling;
          if (more && more.hasAttribute('data-more-replies')) {
            const hidden = more.classList.toggle('hidden');
            btn.textContent = hidden ? btn.textContent.replace('Show less','Show more') : btn.textContent.replace('Show more','Show less');
          }
        });
      });
    });
  </script>
</div>

<!-- Removed bottom mobile bar (Prev/Top/Next) as requested -->

<button id="go-to-top-button" class="hidden fixed bottom-5 right-5 px-3 py-3 rounded-full bg-brand text-white shadow-lg">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-up"><polyline points="18 15 12 9 6 15"></polyline></svg>
</button>

<script src="/js/chapter.js"></script>
<script type="application/ld+json">
  <%- JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'Chapter',
    name: chapter.title,
    isPartOf: { '@type':'Book', name: manga.title, url: '/manga/'+manga.slug },
    url: '/manga/'+manga.slug+'/'+chapter.slug
  }) %>
</script>
