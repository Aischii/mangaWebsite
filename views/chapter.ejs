<% const _chapters = Array.isArray(manga.chapters) ? manga.chapters : []; %>
<% const _idx = _chapters.findIndex(ch => ch.slug === chapter.slug); %>
<% const prevChapter = _idx > 0 ? _chapters[_idx - 1] : null; %>
<% const nextChapter = _idx >= 0 && _idx < _chapters.length - 1 ? _chapters[_idx + 1] : null; %>

<nav class="sticky top-0 z-30 bg-surface/95 backdrop-blur border-b border-white/5">
  <div class="max-w-4xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2 justify-center">
    <div>
      <% if (prevChapter) { %>
        <a href="/manga/<%= manga.slug %>/<%= prevChapter.slug %>" class="px-3 py-2 rounded bg-surface2 hover:bg-surface">Prev</a>
      <% } else { %>
        <button class="px-3 py-2 rounded bg-surface2 opacity-50" disabled>Prev</button>
      <% } %>
    </div>
    <div>
        <select class="chapter-select bg-surface2 rounded px-2 py-2">
          <% _chapters.forEach(ch => { %>
            <option value="/manga/<%= manga.slug %>/<%= ch.slug %>" <%= ch.slug === chapter.slug ? 'selected' : '' %>><%= ch.title %></option>
          <% }); %>
        </select>
    </div>
    <div>
        <select class="page-select bg-surface2 rounded px-2 py-2">
          <% pages.forEach((page, index) => { %>
            <option value="#page-<%= index + 1 %>">Page <%= index + 1 %></option>
          <% }); %>
        </select>
    </div>
    <div>
      <button class="px-3 py-2 rounded bg-brand hover:bg-indigo-500 text-white" id="fullscreen-button">Fullscreen</button>
    </div>
    <div>
      <% if (nextChapter) { %>
        <a href="/manga/<%= manga.slug %>/<%= nextChapter.slug %>" class="px-3 py-2 rounded bg-surface2 hover:bg-surface">Next</a>
      <% } else { %>
        <button class="px-3 py-2 rounded bg-surface2 opacity-50" disabled>Next</button>
      <% } %>
    </div>
  </div>
</nav>

<div class="max-w-4xl mx-auto px-4 py-4 text-center">
  <h1 class="text-lg font-semibold"><a href="/manga/<%= manga.slug %>" class="hover:text-brand"><%= manga.title %></a> - <%= chapter.title %></h1>
  </div>

<div class="max-w-4xl mx-auto px-2 page-container">
  <% pages.forEach((page, index) => { %>
    <div class="text-center">
        <img class="w-full h-auto" src="<%= page %>" alt="Page <%= index + 1 %>" id="page-<%= index + 1 %>">
    </div>
  <% }); %>
</div>

<!-- Reactions + Comments -->
<div class="max-w-4xl mx-auto px-2 mt-8 space-y-4">
  <div class="bg-surface rounded p-4">
    <h3 class="font-semibold mb-3 text-white">What do you think?</h3>
    <div class="flex flex-wrap gap-2 items-center">
      <% const emojis = ['up','funny','love','surprised','angry','sad']; %>
      <% const labels = { up:'Upvote', funny:'Funny', love:'Love', surprised:'Surprised', angry:'Angry', sad:'Sad' }; %>
      <% emojis.forEach(e => { %>
        <form action="/manga/<%= manga.slug %>/<%= chapter.slug %>/react" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="emoji" value="<%= e %>">
          <button class="px-3 py-1.5 rounded bg-surface2 hover:bg-surface text-sm">
            <span class="font-semibold"><%= (reactions && reactions[e]) || 0 %></span> <%= labels[e] %>
          </button>
        </form>
      <% }) %>
    </div>
  </div>

  <div class="bg-surface rounded p-4">
    <h3 class="font-semibold mb-3 text-white">Comments</h3>
    <% if (user) { %>
      <form action="/manga/<%= manga.slug %>/<%= chapter.slug %>/comment" method="POST" class="mb-4">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <textarea name="body" rows="3" class="w-full bg-surface2 rounded px-3 py-2" placeholder="Join the discussion..."></textarea>
        <div class="mt-2"><button class="px-4 py-2 rounded bg-brand hover:bg-indigo-500 text-white">Post</button></div>
      </form>
    <% } else { %>
      <p class="text-sm text-gray-300 mb-3">Log in to join the conversation.</p>
    <% } %>
    <div class="space-y-4">
      <% (comments || []).forEach(c => { %>
        <div class="flex items-start gap-2 text-sm">
          <img src="<%= c.avatar || '/avatars/default.svg' %>" alt="avatar" class="w-5 h-5 rounded-full object-cover bg-surface2 mt-0.5">
          <div class="flex-1 min-w-0">
            <p class="font-semibold"><%= c.nickname || c.username %> <span class="text-xs text-gray-400"><%= c.created_at %></span></p>
            <p class="text-gray-200 break-words"><%= c.body %></p>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</div>

<!-- Removed bottom mobile bar (Prev/Top/Next) as requested -->

<button id="go-to-top-button" class="hidden fixed bottom-5 right-5 px-3 py-3 rounded-full bg-brand text-white shadow-lg">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-up"><polyline points="18 15 12 9 6 15"></polyline></svg>
</button>

<script src="/js/chapter.js"></script>
